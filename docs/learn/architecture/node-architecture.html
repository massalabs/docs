<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-learn/architecture/node-architecture">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">Architecture of Massa node | Massa Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.massa.net/docs/learn/architecture/node-architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture of Massa node | Massa Documentation"><meta data-rh="true" name="description" content="This section assumes some basic knowledge of the Massa protocol. If you are not familiar with the basic concepts of Massa,"><meta data-rh="true" property="og:description" content="This section assumes some basic knowledge of the Massa protocol. If you are not familiar with the basic concepts of Massa,"><link data-rh="true" rel="icon" href="/img/logo.svg"><link data-rh="true" rel="canonical" href="https://docs.massa.net/docs/learn/architecture/node-architecture"><link data-rh="true" rel="alternate" href="https://docs.massa.net/docs/learn/architecture/node-architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.massa.net/docs/learn/architecture/node-architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://HXTTWBHG5G-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Massa Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Massa Documentation Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="Massa Documentation" href="/opensearch.xml">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.77b8741d.css">
<link rel="preload" href="/assets/js/runtime~main.c47d2882.js" as="script">
<link rel="preload" href="/assets/js/main.a7f3c389.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/massa_logo.svg" alt="Massa Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/massa_logo_white.svg" alt="Massa Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Docs</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/learn/home">🎓 Learn</a><a class="navbar__item navbar__link" href="/docs/build/home">🛠️ Build</a><a class="navbar__item navbar__link" href="/docs/tutorial/home">📖 Tutorial</a><a class="navbar__item navbar__link" href="/docs/node/home">🖥 Mainnet</a><a class="navbar__item navbar__link" href="/docs/massaStation/home">🧩 Massa Station</a><a class="navbar__item navbar__link" href="/docs/massaBridge/home">🌉 Massa Bridge</a><a class="navbar__item navbar__link" href="/docs/deweb/home">🌐 Massa DeWeb</a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/home">Home</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><hr></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><span class="menu__link"><b><small> Massa Blockchain </small></b></span></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/introduction">Welcome to Massa</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/architecture/basic-concepts">Basic concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/learn/architecture/node-architecture">Node Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/learn/architecture/node-architecture">Node architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn/architecture/operation-lifecycle">Operation lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/learn/architecture/consensus-quality">Consensus quality initiatives</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/tokenomics">Tokenomics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/bootstrap">Bootstrapping in Massa</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/storage-costs">Storage costs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/gas">Gas</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/operation-format-execution">Detailed operation format and execution sequence</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><hr></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><span class="menu__link"><b><small>Autonomous Smart Contract</small></b></span></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/asc/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/asc/massa-asc">Autonomous Smart Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/asc/use-cases">Use-cases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><hr></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1"><span class="menu__link"><b><small>Decentralized Web</small></b></span></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/learn/decentralized-web">Decentralized Web</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Node Architecture</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Node architecture</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture of Massa node</h1><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>This section assumes some basic knowledge of the Massa protocol. If you are not familiar with the basic concepts of Massa,
read the <a href="/docs/learn/architecture/basic-concepts">Basic Concepts</a> section first.</p></div></div><p>The section describes the global architecture of a Massa node, from the ground up.</p><p>This is the diagram of the architecture of the software modules involved in building, endorsing and propagating blocks.
The bottom part corresponds to a single process running in a node and is in charge of the execution and consensus building.
The pool and factories, referred to as “factory”, can be potentially running in a different process or be part of the node.
Overall, each of the modules described here runs inside one or more threads attached to their respective executable process
(NB: the factory/node separation is not yet implemented, but will be soon).</p><p><img loading="lazy" src="/assets/images/architecture-4a1209c66babdf0750ff11fb839724b3.svg" class="img_ev3q"></p><p>We will explain below the different modules present in this diagram, and simulate the production of an operation to show
how it navigates through the different modules to better understand how blocks are produced and propagated.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bootstrap-module">Bootstrap Module<a href="#bootstrap-module" class="hash-link" aria-label="Direct link to Bootstrap Module" title="Direct link to Bootstrap Module">​</a></h2><p>The bootstrap module is responsible for the initial synchronization of the node with the rest of the network. It is responsible
for downloading the list of peers, the current graph of blocks, the ledger, the asynchronous pool, state of the Proof-of-Stake
and latests executed operations.</p><p>The bootstrap will be done from a server that is listed on the configuration of the node. Bootstrap is the entry point of the
network so you have to be careful on which node you connect to avoid downloading malicious data.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="api-module">API Module<a href="#api-module" class="hash-link" aria-label="Direct link to API Module" title="Direct link to API Module">​</a></h2><p>The API Module is the public window of the node to the rest of the world. It allows for interactions with external clients or
factories via a <a href="/docs/build/api/jsonrpc">JSON RPC</a> and <a href="/docs/build/api/grpc">gRPC</a> protocols.</p><p>The API includes interfaces to do the following:</p><ul><li>publish a new operation from a client</li><li>query the network about balances or ledger status</li><li>allow for synchronization between remote pool/factory nodes and the consensus nodes, by sending/asking for blocks, best
parents, draws, etc.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="protocolnetwork-module">Protocol/Network Module<a href="#protocolnetwork-module" class="hash-link" aria-label="Direct link to Protocol/Network Module" title="Direct link to Protocol/Network Module">​</a></h2><p>The Protocol/Network Module implements the protocol connecting consensus nodes. This protocol is supported by a binary and optimized transport layer.</p><p>The Protocol/Network Module will relay all operations/blocks creation and propagation, so that all other nodes in the
network can synchronize their internal state, following a type of gossip synchronization protocol.</p><p>The type of messages that can be relayed via the Protocol/Network Module include:</p><ul><li>blocks/operations/endorsements propagation (either getting in or out of the node)</li><li>nodes ban requests</li><li>connectivity infos/stats.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="selector-module-proof-of-stake-sybil-resistance">Selector Module, Proof of Stake sybil resistance<a href="#selector-module-proof-of-stake-sybil-resistance" class="hash-link" aria-label="Direct link to Selector Module, Proof of Stake sybil resistance" title="Direct link to Selector Module, Proof of Stake sybil resistance">​</a></h2><p>Every 0.5s, a new slot becomes active to receive a new block. A determinist selection mechanism ensures that one of
the nodes in the network is elected to have the responsibility to build the block for that slot. This mechanism must have several key properties:</p><ul><li><p>it should be sybil resistant, so that it is not possible to increase one’s odds of being elected by creating multiple
clones of oneself (sybil) without a cost that is equal or greater than the cost of increasing one’s odds for oneself only;</p></li><li><p>it should be deterministic, so that all nodes in the network will agree on the result of the selection at any given time;</p></li><li><p>it should be fair, so that each participant has a well-defined probability of being selected somehow proportional to
the cost of participating, and draws converge towards this probability distribution over time.</p></li></ul><p>The way sybil resistance is achieved here is via the proof of stake mechanism. Nodes who want to participate in the block
creation lottery will have to stake “rolls” that they buy with Massa coins. If they try to cheat by creating fake blocks
or multiple blocks on the same slot, their stake will be taken away from them (slashing) and they would suffer the loss.
The probabilistic “surface” of a participant is equal to its total stake, which makes the creation of sybil accounts useless
because the stake would have to be split between them anyway.</p><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>More about slashing mechanism <a href="/docs/learn/architecture/consensus-quality#slashing">here</a></p></div></div><p>The method used to draw an elected node for a given slot is simply a random draw from a distribution where addresses are
weighted by the amount of stake (=rolls) they hold. The schema below illustrates how the seed and probability distribution
are built, based on past cycles (two cycles are needed for the distribution update to ensure that the balance finalization
has occurred and the amount of rolls is accurate):</p><p><img loading="lazy" src="/assets/images/selector-e621b755dcea738530297fb7760b5f31.svg" class="img_ev3q"></p><p>The Selector Module is in charge of computing the formula and replying to requests regarding what node is elected for any
given slot in the present or the past. The Execution Module (see below) is in charge of feeding the Selector Module with
updates regarding balances, needed to compute the draws.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="graphconsensus-module">Graph/Consensus Module<a href="#graphconsensus-module" class="hash-link" aria-label="Direct link to Graph/Consensus Module" title="Direct link to Graph/Consensus Module">​</a></h2><p>The Consensus Module is the heart of the machinery of the Massa Network. It is in charge of integrating proposed blocks
into their respective slots and verifying the integrity of the result. We have not yet talked about the various constraints
regarding block creation, and in particular how parents are to be selected. In traditional blockchains, the parent of a
block is simply the previous valid block in the chain. In the context of the Massa network and the parallel chains in the
32 threads, identifying the proper parent in a given thread requires a more sophisticated strategy involving the notion of block cliques.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="block-cliques">Block cliques<a href="#block-cliques" class="hash-link" aria-label="Direct link to Block cliques" title="Direct link to Block cliques">​</a></h3><p>At any given time, the set of all the blocks that have been produced and propagated in the network constitutes a graph (more precisely
a Directed Acyclic Graph or “DAG”), where each block, except the genesis blocks, has 32 parents. All the reasoning below can be in
principle done on this increasingly vast set, but in practice, we will introduce a notion of “finalized” or “staled” blocks, that
can be removed from the set and that will allow us to work on a smaller subset of recent blocks that are neither finalized nor
staled, so “pending” blocks. This set of pending blocks is all the network needs to know in order to incrementally build up a
consensus, therefore non-pending blocks will simply be forgotten (this is a striking difference with most other blockchains
that store in each node the history of all past transactions). The main benefit of this block pruning is to allow for some of
the algorithms below, which are in general NP-complete, to run fast enough on a smaller subgraph, and to allow for a practical implementation.</p><p>Here is a simplified example of a graph of pending blocks over two threads, with blocks 3 and 4 competing for slot C1 (for example
as a result of a multistaking attack where the block producer decided to create competing blocks for the same slot). Here the
letter of a slot identifies it, while the number refers to its thread number:</p><p><img loading="lazy" src="/assets/images/unfinalized_blocks_set-dfbeffb53e6ae2f5096aac0c02c8c7b6.svg" class="img_ev3q"></p><p>In this illustration we have shown only relevant parent links in blue, to make the whole diagram more readable, but in reality,
each block has 32 parents, one in each of the 32 threads.</p><p>An important notion we will use in the following is that of incompatibility between blocks. Excluding some edge cases with genesis
blocks, there are two sources of incompatibilities defined for blocks:</p><ol><li><strong>thread incompatibility</strong>: this occurs when two blocks in a given thread have the same parent in that thread.</li><li><strong>grandpa incompatibility</strong>: this corresponds to a case with two blocks B1 and B2 in threads t1 and t2, and where the block
B1 in t1 has a parent in t2 who is an ancestor of B2’s parent in t2, and symmetrically B2’s parent in t1 is an ancestor of
B1’s parent in t1.</li></ol><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>You will find a more formal mathematical definition of these incompatibility notions in the <a href="https://arxiv.org/pdf/1803.09029.pdf" target="_blank" rel="noopener noreferrer">whitepaper</a></p></div></div><p>From these definitions, you can build another graph, called the incompatibility graph, which connects any two blocks that
have any form of incompatibility together:</p><p><img loading="lazy" src="/assets/images/incompatibility_graph-3d0cbae75657b115b202ef3d216b2f86.svg" class="img_ev3q"></p><p>As you can see, some blocks are isolated and therefore compatible with any other, while some are linked, because they have
a form of incompatibility.</p><p>This brings us to the notion of a maximal clique which is a subset of the incompatibility graph such as none of the block
members are incompatible with each other (so, no internal link within the clique), and it is impossible to add an extra block
to the set without introducing incompatibilities. In the above example, there are three maximal cliques that can be built,
as illustrated below:</p><p><img loading="lazy" src="/assets/images/cliques-1ea940b8535eb8b547c71482653edeee.svg" class="img_ev3q"></p><p>They represent candidates to extend the set of already finalized blocks into a coherent set of new blocks. All we need to
add to be able to build a consensus rule now is to introduce a deterministic metric to rank those candidates so that nodes
can independently and consistently decide on which clique is the best candidate and keep building on top of it. In particular,
once the best maximal clique is identified, it becomes trivial to define the list of the parents for a new block simply by
picking the oldest block from that clique in each thread.</p><p>The metric used in a traditional blockchain to rank competing chain candidates is habitually the length of the chain, or more
precisely the total amount of work invested in the chain (also known as “Nakamoto consensus”). In the case of block cliques,
we will introduce a notion of fitness for each block, and the fitness of the clique will simply be the sum of all its block’s
fitness. The block fitness <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span> is simply defined as <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mi>e</mi><mo separator="true">,</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">1+e, e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">e</span></span></span></span></span> being the number of endorsements registered in the block.</p><p>Taking the maximal clique with the highest fitness (or some hash-based deterministic selection in case of equality), the
Graph/Consensus module can define what is called the blockclique at the current time.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="finalized-blocks-stale-blocks">Finalized blocks, stale blocks<a href="#finalized-blocks-stale-blocks" class="hash-link" aria-label="Direct link to Finalized blocks, stale blocks" title="Direct link to Finalized blocks, stale blocks">​</a></h3><p>The set of pending blocks is growing each time a new block is produced and added to the current set. As we mentioned previously,
there is also a pruning mechanism in charge of reducing the size of the graph by removing blocks that are considered final, and
also blocks that can be considered stale and will never finalize.</p><p>If a block is only contained inside cliques that have a fitness lower than the fitness of the blockclique (the clique with the maximal fitness), minus a constant <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="normal">Δ</mi><mi>f</mi><mn>0</mn></msubsup></mrow><annotation encoding="application/x-tex">\Delta_{f}^{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2333em;vertical-align:-0.4192em"></span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em">f</span></span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192em"><span></span></span></span></span></span></span></span></span></span></span>, then this block is considered stale. Also, any new block that includes in its parents a stale block is stale.</p><p>A block is considered final if it is part of all maximal cliques, and included in at least one clique where the total sum of the fitness of all its descendants is greater than <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="normal">Δ</mi><mi>f</mi><mn>0</mn></msubsup></mrow><annotation encoding="application/x-tex">\Delta_{f}^{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2333em;vertical-align:-0.4192em"></span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em">f</span></span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192em"><span></span></span></span></span></span></span></span></span></span></span>.</p><p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="normal">Δ</mi><mi>f</mi><mn>0</mn></msubsup></mrow><annotation encoding="application/x-tex">\Delta_{f}^{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2333em;vertical-align:-0.4192em"></span><span class="mord"><span class="mord">Δ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em">f</span></span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4192em"><span></span></span></span></span></span></span></span></span></span></span> is defined as a constant <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">F</span></span></span></span></span> multiplied by <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mi>E</mi></mrow><annotation encoding="application/x-tex">1+E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05764em">E</span></span></span></span></span>
(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi></mrow><annotation encoding="application/x-tex">E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05764em">E</span></span></span></span></span> being the total max number of endorsements in a block, currently 16), and <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi></mrow><annotation encoding="application/x-tex">F</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">F</span></span></span></span></span> effectively measuring the maximum span in fully endorsed blocks of a successful blockclique, or the number of fully endorsed blocks by which an alternative clique can be shorter than the blockclique before its blocks may be discarded as stale.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="graphconsensus-module-function">Graph/Consensus Module Function<a href="#graphconsensus-module-function" class="hash-link" aria-label="Direct link to Graph/Consensus Module Function" title="Direct link to Graph/Consensus Module Function">​</a></h3><p>The Consensus Module (formerly known as the Graph) receives new block proposals, integrates them into the set of pending blocks,
updating the blockclique with the method explained above, and verifying the legitimacy of the parenting of new blocks. It also
informs other modules, like the Execution module, when blocks are finalized and the corresponding ledger modifications implied
by their operations list should be made permanent.</p><p>It is also able to answer queries about the current best parents for a new block (based on the current blockclique) or the list
of current maximal cliques.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-module">Execution Module<a href="#execution-module" class="hash-link" aria-label="Direct link to Execution Module" title="Direct link to Execution Module">​</a></h2><p>The Execution Module is in charge of effectively executing the operations contained in blocks within the current blockclique,
which is provided by the Graph/Consensus Module. Operations will typically modify the ledger, either by changing the balances
of accounts or by modifying the datastore of smart contracts after the execution of some code. From an implementation point
of view, ledger modifications are however stored as diff vs the current finalized ledger, until the corresponding blocks are
marked as finalized by the Graph/Consensus Module.</p><p>Block creators will typically need to query the Execution Module to check current balances at a given slot and verify if some
operations can be run with sufficient funds or not, before being integrated into a new block.</p><p>As a side note, it is also possible that blocks might include invalid operations, in which case the Execution Module will
simply ignore them.</p><p>Being the maintainer of the ledger, the Execution Module is also queried about address information in general, via the API,
for any Module that needs it.</p><p>Finally, the Execution Module will inform the Selector Module when new cycles are initiated as the finalization of blocks
progresses.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pool-module">Pool Module<a href="#pool-module" class="hash-link" aria-label="Direct link to Pool Module" title="Direct link to Pool Module">​</a></h2><p>When new pending operations reach a node, they are not immediately processed but instead are stored in a pool of pending operations,
to be used by the Factory Module. Similarly, proposed endorsements coming from the Endorsement Factory are buffered inside the pool,
to be integrated into new blocks by the Block Factory Module.</p><p>The origin of pending operations or endorsements inside the pool can be internal to the factory process or could come from remote
nodes via the API Module. Similarly, locally produced pending endorsements are broadcasted via a gossip protocol to other pools
via the API Module.</p><p>Note that operations stored in the Pool are naturally discarded after a certain time, since operations come with an expiration
date in the <em>expiration_period</em> field. Still, some potential attacks can occur by trying to flood the pool with high fees
operations that have no chance of being executed because the corresponding account does not have the required funds.
Discussing about countermeasure for this is beyond the scope of this introduction.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="blockendorsement-factory-module">Block/Endorsement Factory Module<a href="#blockendorsement-factory-module" class="hash-link" aria-label="Direct link to Block/Endorsement Factory Module" title="Direct link to Block/Endorsement Factory Module">​</a></h2><p>The Block Factory Module is in charge of creating new blocks when the corresponding node address has been designated to
be the block creator for a given slot. This information is provided to the Factory Module from the Selector Module via
the API Module.</p><p>The Block Factory Module also needs information about the best parents (made of the latest blocks in each thread in
the blockclique) from the Graph/Consensus Module. These parents will be included in the newly created block. Balance
information, in order to assess the validity of pending operations, is obtained from the Execution Module, which
maintains the ledger state from the point of view of the slot where the new block is supposed to be created.</p><p>The Block Factory Module picks pending operations from the Pool Module. Note that the Block Factory will regularly
query the Execution Module about finalized and executed operations, and internally cleanup operations that have been handled.</p><p>Finally, the Block Factory will query the Pool Module and pick pending endorsements corresponding to the best parents
that are selected for the block.</p><p>With this information, it is able to forge a new block that will then be propagated to the Graph/Consensus Module
via the API Module, as well as to other nodes via gossip, to maintain a global synchronized state.</p><p>The Endorsement Factory Module works in a similar manner, requesting the Selector Module to find out when it has been
designated to be an endorsement producer, then feeding new endorsements to the Pool Module and the API Module for global synchronization.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/massalabs/docs/tree/main/docs/learn/architecture/node-architecture.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-10-03T14:32:57.000Z">Oct 3, 2024</time></b> by <b>BenRey</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/learn/architecture/basic-concepts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Basic concepts</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/learn/architecture/operation-lifecycle"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Operation lifecycle</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#bootstrap-module" class="table-of-contents__link toc-highlight">Bootstrap Module</a></li><li><a href="#api-module" class="table-of-contents__link toc-highlight">API Module</a></li><li><a href="#protocolnetwork-module" class="table-of-contents__link toc-highlight">Protocol/Network Module</a></li><li><a href="#selector-module-proof-of-stake-sybil-resistance" class="table-of-contents__link toc-highlight">Selector Module, Proof of Stake sybil resistance</a></li><li><a href="#graphconsensus-module" class="table-of-contents__link toc-highlight">Graph/Consensus Module</a><ul><li><a href="#block-cliques" class="table-of-contents__link toc-highlight">Block cliques</a></li><li><a href="#finalized-blocks-stale-blocks" class="table-of-contents__link toc-highlight">Finalized blocks, stale blocks</a></li><li><a href="#graphconsensus-module-function" class="table-of-contents__link toc-highlight">Graph/Consensus Module Function</a></li></ul></li><li><a href="#execution-module" class="table-of-contents__link toc-highlight">Execution Module</a></li><li><a href="#pool-module" class="table-of-contents__link toc-highlight">Pool Module</a></li><li><a href="#blockendorsement-factory-module" class="table-of-contents__link toc-highlight">Block/Endorsement Factory Module</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/massa" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/massalabs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/massanetwork" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/massalabs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://massa.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">massa.net<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Massa Labs.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.c47d2882.js"></script>
<script src="/assets/js/main.a7f3c389.js"></script>
</body>
</html>